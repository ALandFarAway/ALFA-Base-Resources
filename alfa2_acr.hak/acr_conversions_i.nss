////////////////////////////////////////////////////////////////////////////////
//
//  System Name : ALFA Core Rules
//     Filename : acr_conversions_i
//    $Revision:: 1          $ current version of the file
//        $Date:: 2012-01-07#$ date the file was created or modified
//       Author : Basilica
//
//    Var Prefix: ACR_VERSION
//  Dependencies: NWNX
//
//  Description
//  This file contains the version number string for the ACR.
//
//  Revision History
//  2012/01/07  Basilica    - Created.
//  2012/04/16  Basilica    - Return build date.
//
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Includes ////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

#include "acr_version_i"

////////////////////////////////////////////////////////////////////////////////
// Constants ///////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

const string ACR_CONVERSION_MAXIMUM = "ACR_CONVERSION_MAXIMUM";

////////////////////////////////////////////////////////////////////////////////
// Structures //////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Global Variables ////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////
// Function Prototypes /////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

// Tries to convert oPC from sVersion to the current ACR version.
// Returns TRUE on success.
int TryUpdateCharacterToNewestVersion( object oPC, string sCurrentVersion );

// Swap a feat, if the PC has the feat already.
void _SwapFeat( object oPC, int OldFeat, int NewFeat ) {
	if ( GetHasFeat( OldFeat, oPC ) ) {
		FeatAdd( oPC, NewFeat, FALSE, FALSE );
		FeatRemove( oPC, OldFeat );
	}
}

////////////////////////////////////////////////////////////////////////////////
// Function Definitions ////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int TryUpdateCharacterToNewestVersion( object oPC, string sCurrentVersion )
{
    string sTargetVersion = GetLocalString(GetModule(), ACR_CONVERSION_MAXIMUM);
    if(sTargetVersion == "")
        sTargetVersion = ACR_VERSION;

    float fTargetVersion = StringToFloat(sTargetVersion);
    int bChanged = FALSE;

    if(sCurrentVersion == "" && fTargetVersion > 1.865) // v1.86 -> v1.87
    {
		_SwapFeat( oPC, FEAT_COMBAT_EXPERTISE, FEAT_ACR_COMBAT_EXPERTISE );
		_SwapFeat( oPC, FEAT_IMPROVED_COMBAT_EXPERTISE, FEAT_ACR_IMPROVED_COMBAT_EXPERTISE );
        bChanged = TRUE;
    }
    return bChanged;
}